<!DOCTYPE html>
<html><head><title>Test q.js ESC Handling</title></head><body>
<h2>Test q.js ESC Key Handling</h2>
<div id="txt" style="position: absolute; left: 54px; top: 50px; background: #000; color: #0f0; padding: 10px; font-family: monospace;">
  Text Screen (left: 54px = txt mode)
</div>
<div id="output" style="margin-top: 200px;"></div>

<script>
// Initialize qandy2.htm variables
var run = "";
var allowScriptESC = false;
var mode = "txt";
var keyon = 1;

function log(msg) {
  document.getElementById('output').innerHTML += msg + '<br>';
}

// Load q.js
log('Loading q.js...');
var script = document.createElement('script');
script.src = 'q.js';
script.onload = function() {
  log('✅ q.js loaded successfully!');
  log('run = "' + run + '"');
  log('allowScriptESC = ' + allowScriptESC);
  log('mode = "' + mode + '"');
  log('keydown function exists: ' + (typeof keydown === 'function'));
  log('');
  
  if (allowScriptESC && typeof keydown === 'function') {
    log('✅ ESC opt-out is enabled!');
    log('');
    log('Simulating ESC key press...');
    
    // Test 1: ESC in txt mode
    log('Test 1: mode="txt", pressing ESC...');
    keydown('esc');
    log('After ESC: mode="' + mode + '", txt.style.left="' + document.getElementById('txt').style.left + '"');
    log('Expected: mode="gfx", left="350px"');
    if (mode === 'gfx' && document.getElementById('txt').style.left === '350px') {
      log('✅ PASS: Display moved to gfx mode!');
    } else {
      log('❌ FAIL: Display did not move correctly');
    }
    log('');
    
    // Test 2: ESC in gfx mode
    log('Test 2: mode="gfx", pressing ESC again...');
    keydown('esc');
    log('After ESC: mode="' + mode + '", txt.style.left="' + document.getElementById('txt').style.left + '"');
    log('Expected: mode="txt", left="54px"');
    if (mode === 'txt' && document.getElementById('txt').style.left === '54px') {
      log('✅ PASS: Display moved back to txt mode!');
    } else {
      log('❌ FAIL: Display did not move correctly');
    }
    log('');
    
    // Test 3: Verify universal ESC handler respects opt-out
    log('Test 3: Simulating universal ESC handler...');
    var testRun = run;  // Save current run value
    log('Before: run="' + testRun + '"');
    
    // This simulates qandy2.htm's ESC handler
    if (testRun && !allowScriptESC) {
      log('❌ FAIL: Script would be terminated (allowScriptESC is false)');
    } else if (testRun && allowScriptESC) {
      log('✅ PASS: Script NOT terminated (allowScriptESC is true)');
      log('ESC key will be handled by script');
    } else {
      log('ℹ️  No script running');
    }
    
    log('');
    log('====================');
    log('ALL TESTS COMPLETE!');
    log('====================');
  } else {
    log('❌ FAIL: allowScriptESC not set or keydown not defined!');
    log('This means the fix did NOT work correctly.');
  }
};
script.onerror = function() {
  log('❌ ERROR: Failed to load q.js');
};
document.head.appendChild(script);
</script>
</body></html>
