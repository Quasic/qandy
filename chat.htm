<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Peer Chat</title>
    <script src="peerjs.min.js"></script>
</head>
<body>
    <h3>Your ID: <span id="my-id">...</span></h3>
    <input id="receiver-id" type="text" placeholder="Paste Friend's ID">
    <button onclick="connectToPeer()">Connect</button>

    <div id="chat-box" style="height:200px; border:1px solid #000; overflow-y:scroll; margin:10px 0;"></div>
    
    <input id="msg" type="text" placeholder="Message">
    <button onclick="sendMsg()">Send</button>
    <button onclick="download()">Download Chat</button>

    <script>
        const chatBox = document.getElementById('chat-box');
        const peer = new Peer(); 
        let conn;

        // 1. Display your ID
        peer.on('open', id => document.getElementById('my-id').innerText = id);

        // --- GLOBAL ERROR HANDLING ---
        peer.on('error', err => {
            appendMsg("!!! Error: " + err.type);
            console.error("PeerJS Error:", err);
            
            if(err.type === 'peer-unavailable') {
                alert("The ID you entered does not exist.");
            }
        });

        // 2. Listen for incoming connections
        peer.on('connection', c => {
            conn = c;
            setupReceiver();
        });

        // 3. Connect to a friend
        function connectToPeer() {
            const id = document.getElementById('receiver-id').value;
            if (!id) return alert("Please enter an ID first");
            
            conn = peer.connect(id);
            setupReceiver();
        }

        function setupReceiver() {
            // Handle errors specific to this connection
            conn.on('error', err => {
                appendMsg("!!! Connection Error: " + err);
            });

            conn.on('data', data => appendMsg("Peer: " + data));
            conn.on('open', () => appendMsg("--- Connected ---"));
            
            // Handle accidental disconnection
            conn.on('close', () => appendMsg("--- Peer Disconnected ---"));
        }

        function sendMsg() {
            if (!conn || !conn.open) {
                return alert("No active connection. Please connect to a peer first.");
            }

            const msgInput = document.getElementById('msg');
            const msg = msgInput.value;
            
            try {
                conn.send(msg);
                appendMsg("You: " + msg);
                msgInput.value = "";
            } catch (err) {
                appendMsg("!!! Failed to send message.");
                console.error(err);
            }
        }

        function appendMsg(text) {
            chatBox.innerText += text + "\n";
            chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to bottom
        }

        function download() {
            const blob = new Blob([chatBox.innerText], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat.txt';
            a.click();
        }
    </script>
</body>
</html>

